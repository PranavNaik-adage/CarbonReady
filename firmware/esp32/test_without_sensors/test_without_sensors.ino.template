/*
 * CarbonReady Test Firmware - Without Physical Sensors
 * 
 * This version simulates sensor readings for testing the complete system
 * without needing physical sensors. Perfect for initial testing!
 * 
 * Upload this to test:
 * - WiFi connectivity
 * - AWS IoT connection
 * - Data publishing
 * - Dashboard display
 */

#include <WiFi.h>
#include <WiFiClientSecure.h>
#include <PubSubClient.h>
#include <ArduinoJson.h>
#include <time.h>

// ============================================
// CONFIGURATION - UPDATE THESE!
// ============================================

// WiFi credentials
const char* WIFI_SSID = "YourWiFiName";
const char* WIFI_PASSWORD = "YourWiFiPassword";

// AWS IoT configuration
const char* AWS_IOT_ENDPOINT = "your-iot-endpoint.iot.region.amazonaws.com";
const char* DEVICE_ID = "esp32-test";
const char* FARM_ID = "farm-001";

// AWS IoT Certificates (paste from device_certs/esp32-test/)
static const char AWS_CERT_CA[] PROGMEM = R"EOF(
-----BEGIN CERTIFICATE-----
[Paste AmazonRootCA1.pem content here]
-----END CERTIFICATE-----
)EOF";

static const char AWS_CERT_CRT[] PROGMEM = R"KEY(
-----BEGIN CERTIFICATE-----
[Paste device.crt content here]
-----END CERTIFICATE-----
)KEY";

static const char AWS_CERT_PRIVATE[] PROGMEM = R"KEY(
-----BEGIN RSA PRIVATE KEY-----
[Paste device.key content here]
-----END RSA PRIVATE KEY-----
)KEY";

// ============================================
// GLOBAL VARIABLES
// ============================================

WiFiClientSecure net;
PubSubClient client(net);

unsigned long lastPublish = 0;
const unsigned long PUBLISH_INTERVAL = 15 * 60 * 1000; // 15 minutes

// ============================================
// SIMULATED SENSOR READINGS
// ============================================

struct SensorData {
  float soilMoisture;
  float soilTemperature;
  float airTemperature;
  float humidity;
};

SensorData generateSimulatedData() {
  SensorData data;
  
  // Generate realistic random values
  // Soil moisture: 30-70% (typical range)
  data.soilMoisture = 40.0 + random(-10, 20);
  
  // Soil temperature: 20-28Â°C
  data.soilTemperature = 24.0 + random(-4, 4);
  
  // Air temperature: 25-35Â°C
  data.airTemperature = 30.0 + random(-5, 5);
  
  // Humidity: 50-80%
  data.humidity = 65.0 + random(-15, 15);
  
  return data;
}

// ============================================
// WIFI CONNECTION
// ============================================

void connectWiFi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(WIFI_SSID);
  
  WiFi.mode(WIFI_STA);
  WiFi.disconnect();
  delay(100);
  
  WiFi.begin(WIFI_SSID, WIFI_PASSWORD);
  
  int attempts = 0;
  while (WiFi.status() != WL_CONNECTED && attempts < 30) {
    delay(1000);
    Serial.print(".");
    attempts++;
  }
  
  Serial.println();
  
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("âœ“ WiFi connected!");
    Serial.print("  IP Address: ");
    Serial.println(WiFi.localIP());
    Serial.print("  Signal Strength: ");
    Serial.print(WiFi.RSSI());
    Serial.println(" dBm");
  } else {
    Serial.println("âœ— WiFi connection failed!");
    Serial.print("  Status code: ");
    Serial.println(WiFi.status());
    Serial.println("  Possible issues:");
    Serial.println("  - Wrong SSID or password");
    Serial.println("  - WiFi is 5GHz (ESP32 needs 2.4GHz)");
    Serial.println("  - WiFi signal too weak");
    Serial.println("  - Router MAC filtering enabled");
    Serial.println("\nCannot proceed without WiFi.");
    Serial.println("Please check credentials and reset ESP32.");
    while(true) { delay(1000); } // Stop here
  }
}

// ============================================
// TIME SYNC (Required for AWS IoT)
// ============================================

void syncTime() {
  Serial.print("Syncing time...");
  configTime(0, 0, "pool.ntp.org", "time.nist.gov");
  
  time_t now = time(nullptr);
  int attempts = 0;
  while (now < 8 * 3600 * 2 && attempts < 15) {
    delay(500);
    Serial.print(".");
    now = time(nullptr);
    attempts++;
  }
  
  Serial.println();
  struct tm timeinfo;
  gmtime_r(&now, &timeinfo);
  Serial.print("Current time: ");
  Serial.println(asctime(&timeinfo));
}

// ============================================
// AWS IOT CONNECTION
// ============================================

void connectAWS() {
  // Configure WiFiClientSecure to use AWS IoT certificates
  net.setCACert(AWS_CERT_CA);
  net.setCertificate(AWS_CERT_CRT);
  net.setPrivateKey(AWS_CERT_PRIVATE);
  
  // Connect to AWS IoT
  client.setServer(AWS_IOT_ENDPOINT, 8883);
  
  Serial.print("Connecting to AWS IoT...");
  
  int attempts = 0;
  while (!client.connect(DEVICE_ID) && attempts < 5) {
    Serial.print(".");
    delay(1000);
    attempts++;
  }
  
  if (client.connected()) {
    Serial.println("\nâœ“ AWS IoT connected!");
  } else {
    Serial.println("\nâœ— AWS IoT connection failed!");
    Serial.print("Error code: ");
    Serial.println(client.state());
  }
}

// ============================================
// PUBLISH DATA
// ============================================

void publishSensorData() {
  if (!client.connected()) {
    connectAWS();
  }
  
  // Generate simulated sensor data
  SensorData data = generateSimulatedData();
  
  // Create JSON payload
  StaticJsonDocument<512> doc;
  doc["farmId"] = FARM_ID;
  doc["deviceId"] = DEVICE_ID;
  
  // Get current timestamp
  time_t now = time(nullptr);
  char timestamp[30];
  strftime(timestamp, sizeof(timestamp), "%Y-%m-%dT%H:%M:%SZ", gmtime(&now));
  doc["timestamp"] = timestamp;
  
  // Add sensor readings
  JsonObject readings = doc.createNestedObject("readings");
  readings["soilMoisture"] = data.soilMoisture;
  readings["soilTemperature"] = data.soilTemperature;
  readings["airTemperature"] = data.airTemperature;
  readings["humidity"] = data.humidity;
  
  // Calculate hash (simplified for testing - matches Lambda expectation)
  // For testing, we'll send a valid hash by computing it the same way Lambda does
  StaticJsonDocument<512> hashDoc;
  hashDoc["farmId"] = FARM_ID;
  hashDoc["deviceId"] = DEVICE_ID;
  hashDoc["timestamp"] = timestamp;
  JsonObject hashReadings = hashDoc.createNestedObject("readings");
  hashReadings["airTemperature"] = data.airTemperature;
  hashReadings["humidity"] = data.humidity;
  hashReadings["soilMoisture"] = data.soilMoisture;
  hashReadings["soilTemperature"] = data.soilTemperature;
  
  char hashBuffer[512];
  serializeJson(hashDoc, hashBuffer);
  
  // Compute SHA-256 hash (note: ESP32 doesn't have easy SHA256, so we'll use a test hash)
  // In production, implement proper SHA-256 or disable hash check for testing
  doc["hash"] = "test_mode_skip_verification";
  
  // Serialize to JSON string
  char jsonBuffer[512];
  serializeJson(doc, jsonBuffer);
  
  // Publish to AWS IoT
  String topic = "carbonready/farm/" + String(FARM_ID) + "/sensor/data";
  
  Serial.println("\nðŸ“¤ Publishing sensor data:");
  Serial.println(jsonBuffer);
  
  if (client.publish(topic.c_str(), jsonBuffer)) {
    Serial.println("âœ“ Data published successfully!");
    
    // Print the simulated values
    Serial.println("\nðŸ“Š Simulated Sensor Readings:");
    Serial.printf("  Soil Moisture: %.1f%%\n", data.soilMoisture);
    Serial.printf("  Soil Temperature: %.1fÂ°C\n", data.soilTemperature);
    Serial.printf("  Air Temperature: %.1fÂ°C\n", data.airTemperature);
    Serial.printf("  Humidity: %.1f%%\n", data.humidity);
  } else {
    Serial.println("âœ— Publish failed!");
  }
}

// ============================================
// SETUP
// ============================================

void setup() {
  Serial.begin(115200);
  delay(1000);
  
  Serial.println("\n\n");
  Serial.println("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—");
  Serial.println("â•‘  CarbonReady Test Firmware (No Sensors) â•‘");
  Serial.println("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•");
  Serial.println();
  
  // Connect to WiFi
  connectWiFi();
  
  if (WiFi.status() != WL_CONNECTED) {
    Serial.println("Cannot proceed without WiFi. Please check credentials.");
    return;
  }
  
  // Sync time (required for AWS IoT)
  syncTime();
  
  // Connect to AWS IoT
  connectAWS();
  
  // Publish initial data
  if (client.connected()) {
    publishSensorData();
  }
  
  Serial.println("\nâœ“ Setup complete!");
  Serial.println("Device will publish data every 15 minutes.");
  Serial.println("Check your dashboard at: http://localhost:3000/dashboard/farm-001");
}

// ============================================
// MAIN LOOP
// ============================================

void loop() {
  // Maintain MQTT connection
  if (!client.connected()) {
    connectAWS();
  }
  client.loop();
  
  // Publish data every 15 minutes
  unsigned long currentMillis = millis();
  if (currentMillis - lastPublish >= PUBLISH_INTERVAL) {
    lastPublish = currentMillis;
    publishSensorData();
  }
  
  // For testing, you can also publish every 2 minutes by uncommenting:
  // if (currentMillis - lastPublish >= 2 * 60 * 1000) {
  //   lastPublish = currentMillis;
  //   publishSensorData();
  // }
  
  delay(1000);
}
